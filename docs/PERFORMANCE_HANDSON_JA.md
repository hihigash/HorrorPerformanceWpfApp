# シナリオ

(想像してください...💭)  
あなたは、国内大手ショッピング サイトを運営する企業で、顧客情報管理アプリケーションのメンテナンスを担当するエンジニア。  
その WPF 製デスクトップ アプリは、全国数千の販売拠点でも使われており、日々の業務を支えています。

数か月前、経営層から「顧客の購買年齢層が高くなってきている」との声を受け、前任者が顧客の平均年齢を表示する新機能を実装しました。  
ところが──それ以降、アプリの起動が異常に遅くなり、現場から苦情が相次ぐように。起動に数秒以上かかることもあり、操作にも違和感が残っています。

前任者はすでに退職。  
いま、この問題の原因を突き止め、修正できるのは、**あなた**しかいません。

Visual Studio と GitHub Copilot を武器に、この "負の遺産" を、あなたの手で最適化してください！

# 演習

## 手順 1 : 🛠️ ビルドと実行

まずは実際にあなたの目で問題を確認してみましょう。

  1. このリポジトリをローカルに取得します。。
  2. Visual Studio 2022 を起動し、ソリューションを開きます。
  3. ソリューションをビルドし、アプリをデバッグ実行します。
  4. 起動までに時間がかかる事象が再現するかどうかを確認します。(アプリのステータスバーに実行に掛かった時間が表示されます)
  5. 起動後、スクロール バーを操作し、応答性能を確認します。

### ✅ 確認事項
  - [ ] 事象を再現させる
  - [ ] 実際の起動時間を確認する
  - [ ] スクロールバーを操作し、描画性能を確認する

## 手順 2 : 🚀 パフォーマンス プロファイラーを実行する

> [!CAUTION]  
> この手順では問題コードの修正は行いません。
> まずは、プロファイラーを使用して問題の分析を行います。

実行した結果、明らかにパフォーマンス問題があることが確認できました。  
このようにアプリのパフォーマンス問題を確認した場合の最初の調査手段は、プロファイラーを実行することです。  

実際にプロファイラーを使用して、問題を調査してみましょう。

  1. メニュー バーから [`デバッグ`] - [`パフォーマンス プロファイラー`] の順にクリックします。
  2. `分析ターゲット` ウィンドウが表示されますので、`使用可能なツール` から [`CPU 使用率`] にチェックします。
  3. 下部の [`開始`] ボタンをクリックします。
  4. アプリが起動するまでしばらく待ちます。
  5. アプリの起動を確認後、アプリを終了します。
  6. アプリを終了すると診断セッションが終了し、分析後にレポートが表示されます (これには時間がかかることがあります)
  7. 診断レポートの `上位の関数` セクションに表示される関数名 (メソッド名) に問題のメソッドが表示されます。これが問題のメソッドと考えられます。("外部呼び出し"と記載されているものは無視します)
  8. 問題のメソッドをクリックし、該当のコードを確認します。

GitHub Copilot が有効な場合は、Visual Studio のプロファイラー機能がさらに強化され、問題の調査や改善に Copilot を活用できます。

実際に GitHub Copilot の機能を使用してみましょう。

  1. 診断レポートの `重要な分析情報` に表示される [`GitHub Copilot に質問する`] をクリックします。
  2. `GitHub Copilot チャット` ウィンドウがアクティブになり、パフォーマンス問題の調査結果と対策が表示されます。
  3. 診断レポートの `重要な分析情報` に Copilot が提案した問題と改善方法の説明が表示されていることを確認します。
      - [`ソースコードの表示`] をクリックして問題のコードに移動することが可能です
      - [`Copilot に質問する`] をクリックして、対象の問題と改善方法を更に Copilot に質問することができます。
  4. `上位の関数` から問題のメソッドをクリックします。
  5. コード部分の上部に表示される [`Copilot を使用してメソッドを分析する`] をクリックします。
  6. Copilot チャットに具体的なコードの修正提案が表示されます。

> [!WARNING]  
> GitHub Copilot の提案は、必ずしも正確または最適とは限りません。  
> さらに、生成 AI の回答は一律ではないため、ご利用の環境や状況によって異なる結果となる場合があります。  
> 意図しない結果が出た場合は、再度プロファイルを取得してください。  
> （今回のケースでは、スクロール操作を繰り返すと「上位の関数」の先頭が外部呼び出しメソッドとなり、現象が再現しないことがあります）

### ✅ 確認事項
  - [ ] プロファイラーを使用して問題のメソッドを特定する
  - [ ] Copilot を使用して、重要な分析情報の結果を取得し、パフォーマンス改善項目を把握する
  - [ ] 問題のある対象メソッドを GitHub Copilot を使用して分析し、コードの問題点と改善案を把握する

## 手順 3 : 🧪 単体テストを実行する

プロファイラーの調査から、今回の問題は `CalculateComplexAge()` にあることが判明しました。

Copilot の提案をすぐに実装することもできますが、パフォーマンス要件 (非機能要件) を検証する目的で単体テストが用意されていることを思い出しました。  
実際に単体テストを使用して、テストに問題が発生しているかどうかを確認してみましょう。

  1. ソリューション エクスプローラーから `HorrorPerformanceWpfApp.Tests` プロジェクトの `UserManagerTests.cs` を開きます。
  2. コード上の `UserManagerTests` クラスを選択した状態でコンテキスト メニューを開き、[`テストの実行`] をクリックします。
  3. `テスト エクスプローラー` ウィンドウが開き、テストの実行結果が表示されます。
  4. テストの実行結果から、失敗しているテストを確認します。

GitHub Copilot が有効な場合は、失敗した単体テストの問題の調査やデバッグに Copilot を活用できます。

実際に GitHub Copilot の機能を使用してみましょう。

  1. 失敗したテストを開きます。
  2. 右ペインの上部に表示された [`Copilot に質問する`] ボタンをクリックし、`Copilot を使用したエラーの説明` を選択します。
  3. `GitHub Copilot チャット` ウィンドウがアクティブになり、失敗の原因を自然言語で理解することができます。
  4. 次に、 [`Copilot に質問する`] ボタンをクリックし、`Copilot を使用したデバッグ` を選択します。
  5. 対象テストのデバッグ実行が開始され、GitHub Copilot が問題を調査するためのブレークポイントの設定と値の検査を実施します。
  6. `GitHub Copilot チャット` ウィンドウがアクティブになり、ブレークポイントに到達すると問題の調査を行います。GitHub Copilot の指示に従って、デバッグの実行を行います。
  7. GitHub Copilot が問題を特定すると、原因について説明を出力します。
      <details>
      <summary>出力例 : Copilot による問題の説明</summary>
      <blockquote>
        <p>
          <code>CalculateComplexAge</code> メソッド内で <strong>100,000 回のループ</strong>が実行されており、これが <code>GetAverageAge</code> の実行時間を 1 秒以上にしてテスト失敗の原因となっています。ループの削除や最適化が必要です。
        </p>
      </blockquote>
      </details>
  8. デバッグを停止します。

### ✅ 確認事項
  - [ ] 単体テストが失敗することを確認する
  - [ ] 失敗の理由を GitHub Copilot を使用して把握する
  - [ ] GitHub Copilot を使用して対象テストをデバッグする

## 手順 4 : 🔧 問題を修正する

パフォーマンス要件を検証するためのテストも失敗していました。  
問題は `CalculateComplexAge()` メソッドに不要な実装が存在することなので、この問題を GitHub Copilot と共に修正しましょう。

  1. `CalculateComplexAge()` メソッドのコードを開きます
  2. メソッド名にカーソルがある状態で <kbd>Ctrl + /</kbd> を押下するか、コンテキスト メニューを開き、[`Copilot に質問する`] するをクリックします。
  3. `/optimize` コマンドを指定して実行します。
  4. GitHub Copilot によって、最適化されたコードが提案されますので、コード内容を確認し、受け入れる場合は <kbd>Tab</kbd> を押下します。

コードが改善されたら、次の操作を行い問題が解消されたかどうかを確認してみましょう。

  - プロファイラーを実行し、コードが改善されたかどうかを確認する
  - 単体テストを実行し、テストが成功するかどうかを確認する

### ✅ 確認事項
  - [ ] `/opitmize` コマンドでコードを最適化する方法を理解する
  - [ ] パフォーマンスの改善が行われたことを確認する

## 手順 5 : ⏩ 起動時間を更に短縮する

パフォーマンス問題の原因を取り除くことが出来ました！──しかし、まだ問題が残っているようです。
修正後にアプリを実行すると、依然として 2 秒以上の時間がかかっていることが確認できます。

このようにソースコード上のどこかでパフォーマンスの原因となっているコードを調べる場合にも、GitHub Copilot は役立ちます。

実際に GitHub Copilot を使用してパフォーマンスの問題を特定してみましょう。

  1. `GitHub Copilot チャット` ウィンドウを開きます。
  2. `質問 (ASK)` モードで、アプリ起動が遅い問題を**あなたの言葉**で GitHub Copilot に質問します。
      > [!TIP]  
      > 今回のように現在開いているソリューション全体に対しての質問や、ソリューションのどこかに存在する該当のコードを調べたい、という場合は `@ワークスペース` (`@Workspace`) を使用します。
  3. GitHub Copilot の回答を確認します。(説明中のリンクをクリックすると、該当コードに移動することが可能です)

調査の結果、デバッグ目的で残されていたコードが原因で 2 秒の遅延が発生していたことが特定できるはずです。問題のコードを削除し、問題が解消されるかどうかを確認してみましょう。

### ✅ 確認事項
  - [ ] GitHub Copilot で `@ワークスペース` を使用するコツを理解する
  - [ ] GitHub Copilot チャットでパフォーマンス問題の原因を特定する


## 手順 6 : 🔧 (オプション) 更なる改善を試みる

> [!WARNING]
> ⌛ この手順はオプションです。演習時間に余裕がある場合にのみ実施してください。

重大なパフォーマンス問題は改善されましたが、実コードを読むと不要なコードや改善できるコードはまだまだあるようです。  
GitHub Copilot を活用して、アプリのパフォーマンスを改善させましょう！(めざせ、最速！🚀)

<details>
<summary>💡 パフォーマンス改善のためのヒント</summary>
  <ul>
    <li>平均年齢計算内で実行されているループを修正する</li>
    <li>CSV の読み込みと年齢計算を UI スレッド上で実行しない</li>
    <li>DataGrid を仮想化する</li>
  </ul>
</details>
